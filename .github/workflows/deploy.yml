name: Deploy VitePress site to Tencent Cloud COS

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 设置时区
      - name: Set timezone
        run: sudo timedatectl set-timezone Asia/Shanghai

      # 记录开始时间
      - name: Record start time
        run: echo "START_TIME=$(date +%s)" >> $GITHUB_ENV

      # 拉取代码
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 设置 pnpm
      - uses: pnpm/action-setup@v3
        with:
          version: 9

      # 设置 Node
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      # 缓存 pnpm
      - name: Cache pnpm
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      # 安装依赖
      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      # 构建 VitePress（根据你的脚本改）
      - name: Build with VitePress
        run: pnpm build

      # 设置 Python 3.10 版本
      - name: Set Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # 缓存 pip
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      - name: Instal coscmd
        run: pip install coscmd

      - name: Config coscmd
        run: |
          coscmd config -a ${{ secrets.TENCENT_SECRET_ID }} -s ${{ secrets.TENCENT_SECRET_KEY }} -b ${{ secrets.TENCENT_BUCKET }} -r ${{ secrets.TENCENT_REGION }}
      - name: Upload COS
        run: |
          coscmd upload -rs --skipmd5 dist ./
      # 成功通知 (飞书)
      - name: Notify Feishu (success)
        if: success()
        env:
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
          START_TIME: ${{ env.START_TIME }}
        run: |
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          MINUTES=$((DURATION / 60))
          SECONDS=$((DURATION % 60))
          TIME_STR="${MINUTES}分${SECONDS}秒"
          EXEC_TIME=$(date '+%Y-%m-%d %H:%M:%S')
          curl -X POST "$FEISHU_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d "{
              \"msg_type\": \"interactive\",
              \"card\": {
                \"config\": {\"wide_screen_mode\": false},
                \"header\": {
                  \"title\": {\"tag\": \"plain_text\", \"content\": \"✅ youyou-notes 部署成功通知\"},
                  \"template\": \"green\"
                },
                \"elements\": [
                  {\"tag\": \"div\", \"text\": {\"tag\": \"lark_md\", \"content\": \"**执行分支：** ${{ github.ref_name }}\n**执行环境：** 日常环境\n**执行时间：** ${EXEC_TIME}\n**执行备注：** ${{ github.event.head_commit.message }}\n**执行人员：** ${{ github.actor }}\n**运行耗时：** ${TIME_STR}\n**访问地址：** [点击访问](https://notes.qiuyouyou.cn)\"}}
                ]
              }
            }"
      # 失败通知 (飞书)
      - name: Notify Feishu (failure)
        if: failure()
        env:
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
          START_TIME: ${{ env.START_TIME }}
        run: |
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          MINUTES=$((DURATION / 60))
          SECONDS=$((DURATION % 60))
          TIME_STR="${MINUTES}分${SECONDS}秒"
          EXEC_TIME=$(date '+%Y-%m-%d %H:%M:%S')
          curl -X POST "$FEISHU_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d "{
              \"msg_type\": \"interactive\",
              \"card\": {
                \"config\": {\"wide_screen_mode\": false},
                \"header\": {
                  \"title\": {\"tag\": \"plain_text\", \"content\": \"❌ youyou-notes 部署失败通知\"},
                  \"template\": \"red\"
                },
                \"elements\": [
                  {\"tag\": \"div\", \"text\": {\"tag\": \"lark_md\", \"content\": \"**执行分支：** ${{ github.ref_name }}\n**执行环境：** 日常环境\n**执行时间：** ${EXEC_TIME}\n**执行备注：** ${{ github.event.head_commit.message }}\n**执行人员：** ${{ github.actor }}\n**运行耗时：** ${TIME_STR}\n**访问地址：** [点击访问](https://notes.qiuyouyou.cn)\"}}
                ]
              }
            }"
